---
title: "Mushroom Classification"
author: "Rahim Jutha"
date: "2023-07-13"
output: html_document
---

# Introduction

Let's build a classification model for predicting the whether a mushroom is poisonous or edible based on a plethora of qualitative variables.

Using the UCI Machine Learning dataset downloaded from [kaggle](https://www.kaggle.com/datasets/uciml/mushroom-classification) we can look at which characteristics of mushrooms are poisonous and which are palatable. The goal of this analysis is to not only figure out which features are important but also to have high accuracy model since classifying wrong could spell death. 

# Load Dependencies

```{r}
library(tidyverse)
library(tidymodels)
library(cowplot)
library(janitor)
library(ggfittext)
library(rcartocolor)
```

# Load the Data

```{r}
mushrooms <- read_csv('mushrooms.csv') %>% clean_names()

mushrooms %>% glimpse()

mushrooms %>% distinct() %>% nrow()
mushrooms %>% is.na() %>% sum()
```

Here we can see that we 23 different columns and 8124 observations. We have 0 repeating observations as well as 0 missing values which is ideal. However, all of our data is encoding is assigned to different letters representing factors which can be confusing when working with this data for the first time. As an example, the value 'e' in cap_color corresponds to the color red. For clarity, I will replace these characters with the corresponding factor names which will also enhance any data visualizations I make in the future.

```{r}
mushrooms_df <-
  mushrooms %>%
  mutate(
    class = case_when(
      class == "p" ~ "poisonous", 
      class == "e" ~ "edible"),
    cap_shape = case_when(
      cap_shape == 'b' ~ 'bell',
      cap_shape == 'c' ~ 'conical',
      cap_shape == 'x' ~ 'convex',
      cap_shape == 'f' ~ 'flat',
      cap_shape == 'k' ~ 'knobbed',
      cap_shape == 's' ~ 'sunken'),
    cap_surface = case_when(
      cap_surface == 'f' ~ 'fibrous',
      cap_surface == 'g' ~ 'grooves',
      cap_surface == 'y' ~ 'scaly',
      cap_surface == 's' ~ 'smooth'),
    cap_color = case_when(
      cap_color == 'n' ~ 'brown',
      cap_color == 'b' ~ 'buff',
      cap_color == 'c' ~ 'cinnamon',
      cap_color == 'g' ~ 'gray',
      cap_color == 'r' ~ 'green',
      cap_color == 'p' ~ 'pink',
      cap_color == 'u' ~ 'purple',
      cap_color == 'e' ~ 'red',
      cap_color == 'w' ~ 'white',
      cap_color == 'y' ~ 'yellow'),
    bruises = case_when(
      bruises == TRUE ~ 'yes',
      bruises == FALSE ~ 'no'
    ),
    odor = case_when(
      odor == 'a' ~ 'almond',
      odor == 'l' ~ 'anise',
      odor == 'c' ~ 'creosote',
      odor == 'y' ~ 'fishy',
      odor == 'f' ~ 'foul',
      odor == 'm' ~ 'musty',
      odor == 'n' ~ 'none',
      odor == 'p' ~ 'pungent',
      odor == 's' ~ 'spicy'),
    gill_attachment = case_when(
      gill_attachment == 'a' ~ 'attached',
      gill_attachment == 'd' ~ 'descending',
      gill_attachment == 'f' ~ 'free',
      gill_attachment == 'n' ~ 'notched'),
    gill_spacing = case_when(
      gill_spacing == 'c' ~ 'close',
      gill_spacing == 'w' ~ 'crowded',
      gill_spacing == 'd' ~ 'distant'),
    gill_size = case_when(
      gill_size == 'b' ~ 'broad',
      gill_size == 'n' ~ 'narrow'),
    gill_color = case_when(
      gill_color == 'k' ~ 'black',
      gill_color == 'n' ~ 'brown',
      gill_color == 'b' ~ 'buff',
      gill_color == 'h' ~ 'chocolate',
      gill_color == 'g' ~ 'gray',
      gill_color == 'r' ~ 'green',
      gill_color == 'o' ~ 'orange',
      gill_color == 'p' ~ 'pink',
      gill_color == 'u' ~ 'purple',
      gill_color == 'e' ~ 'red',
      gill_color == 'w' ~ 'white',
      gill_color == 'y' ~ 'yellow'),
    stalk_shape = case_when(
      stalk_shape == 'e' ~ 'enlarging',
      stalk_shape == 't' ~ 'tapering'),
    stalk_root = case_when(
        stalk_root == 'b' ~ 'bulbous',
        stalk_root == 'c' ~ 'club',
        stalk_root == 'u' ~ 'cup',
        stalk_root == 'e' ~ 'equal',
        stalk_root == 'z' ~ 'rhizomorphs',
        stalk_root == 'r' ~ 'rooted',
        stalk_root == '?' ~ 'missing'),
    stalk_surface_above_ring = case_when(
      stalk_surface_above_ring == 'f' ~ 'fibrous',
      stalk_surface_above_ring == 'y' ~ 'scaly',
      stalk_surface_above_ring == 'k' ~ 'silky',
      stalk_surface_above_ring == 's' ~ 'smooth'),
    stalk_surface_below_ring = case_when(
      stalk_surface_below_ring == 'f' ~ 'fibrous',
      stalk_surface_below_ring == 'y' ~ 'scaly',
      stalk_surface_below_ring == 'k' ~ 'silky',
      stalk_surface_below_ring == 's' ~ 'smooth'),
      stalk_color_above_ring = case_when(
      stalk_color_above_ring == 'n' ~ 'brown',
      stalk_color_above_ring == 'b' ~ 'buff',
      stalk_color_above_ring == 'c' ~ 'cinnamon',
      stalk_color_above_ring == 'g' ~ 'gray',
      stalk_color_above_ring == 'o' ~ 'orange',
      stalk_color_above_ring == 'p' ~ 'pink',
      stalk_color_above_ring == 'e' ~ 'red',
      stalk_color_above_ring == 'w' ~ 'white',
      stalk_color_above_ring == 'y' ~ 'yellow'),
    stalk_color_below_ring = case_when(
      stalk_color_below_ring == 'n' ~ 'brown',
      stalk_color_below_ring == 'b' ~ 'buff',
      stalk_color_below_ring == 'c' ~ 'cinnamon',
      stalk_color_below_ring == 'g' ~ 'gray',
      stalk_color_below_ring == 'o' ~ 'orange',
      stalk_color_below_ring == 'p' ~ 'pink',
      stalk_color_below_ring == 'e' ~ 'red',
      stalk_color_below_ring == 'w' ~ 'white',
      stalk_color_below_ring == 'y' ~ 'yellow'),
    veil_type = case_when(
      veil_type == 'p' ~ 'partial',
      veil_type == 'u' ~ 'univeral'),
    veil_color = case_when(
      veil_color == 'n' ~ 'brown',
      veil_color == 'o' ~ 'orange',
      veil_color == 'w' ~ 'white',
      veil_color == 'y' ~ 'yellow'),
    ring_number = case_when(
      ring_number == 'n' ~ 'none',
      ring_number == 'o' ~ 'one',
      ring_number == 't' ~ 'two'),
    ring_type = case_when(
      ring_type == 'c' ~ 'cobwebby',
      ring_type == 'e' ~ 'evanescent',
      ring_type == 'f' ~ 'flaring',
      ring_type == 'l' ~ 'large',
      ring_type == 'n' ~ 'none',
      ring_type == 'p' ~ 'pendent',
      ring_type == 's' ~ 'sheathing',
      ring_type == 'z' ~ 'zone'),
    spore_print_color = case_when(
      spore_print_color == 'k' ~ 'black',
      spore_print_color == 'n' ~ 'brown',
      spore_print_color == 'b' ~ 'buff',
      spore_print_color == 'h' ~ 'chocolate',
      spore_print_color == 'r' ~ 'green',
      spore_print_color == 'o' ~ 'orange',
      spore_print_color == 'u' ~ 'purple',
      spore_print_color == 'w' ~ 'white',
      spore_print_color == 'y' ~ 'yellow'),
    population = case_when(
      population == 'a' ~ 'abundent',
      population == 'c' ~ 'clustered',
      population == 'n' ~ 'numerous',
      population == 's' ~ 'scattered',
      population == 'v' ~ 'several',
      population == 'y' ~ 'solitary'),
    habitat = case_when(
      habitat == 'g' ~ 'grasses',
      habitat == 'l' ~ 'leaves',
      habitat == 'm' ~ 'meadows',
      habitat == 'p' ~ 'paths',
      habitat == 'u' ~ 'urban',
      habitat == 'w' ~ 'waste',
      habitat == 'd' ~ 'woods')
  )

mushrooms_df %>% glimpse()
```

# EDA

## First Guesses

Let's take a look at a couple of the variables that could be important. As someone who doesn't pick mushrooms, my best guesses for which features are important are

- Bruises - Indicates whether the mushroom has bruises or not
- Population - Describes the population of mushrooms
- Habitat - Specifies the habitat where the mushroom is found
- Odor - Describes the odor of the mushroom

```{r}
plot_individual_vars <- function(df, var){
  df %>%
    group_by(class, .data[[var]]) %>%
    summarise(prop_var_class = n()) %>%
    ungroup() %>%
    group_by(.data[[var]]) %>%
    mutate(prop_var = sum(prop_var_class)) %>%
    ungroup() %>%
    mutate(percent = prop_var_class / prop_var) %>%
    ggplot(aes(x = prop_var_class, y = fct_reorder(.data[[var]], prop_var),
               fill = class, label = percent %>%  percent(accuracy = 1))) +
    geom_col(position = 'stack') +
    geom_bar_text(position = "stack", place = 'center', reflow = TRUE, contrast = TRUE) +
    theme_minimal_vgrid() +
    labs(
      title = paste("Exploring the", var, "feature."),
      x = 'Frequency',
      y = NULL
    ) +
    scale_fill_carto_d(name = "class",
                           type = "diverging", palette = "Earth", direction = -1)
}

plot_individual_vars(mushrooms_df, "bruises")
plot_individual_vars(mushrooms_df, "population")
plot_individual_vars(mushrooms_df, "habitat")
plot_individual_vars(mushrooms_df, "odor")
```

```{r}
mushrooms_df %>%
  ggplot(aes(x = bruises, fill = class)) +
  facet_grid(~population) +
  geom_bar()

mushrooms_df %>%
  ggplot(aes(x = odor, fill = class)) +
  facet_grid(~habitat) +
  geom_bar() +
  coord_flip()
```